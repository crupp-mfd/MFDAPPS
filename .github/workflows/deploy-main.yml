name: Deploy Main to mfd-automation

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

env:
  APP_NAME: mfd-automation
  RESOURCE_GROUP: rg-mfd-automation
  ACR_NAME: acrmfdauto10028
  IMAGE_REPO: appmfd

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and Push Image
        id: build
        run: |
          set -euo pipefail
          TS="$(date +%Y%m%d-%H%M%S)"
          SHORT_SHA="${GITHUB_SHA::7}"
          IMAGE_TAG="${TS}-${SHORT_SHA}"
          IMAGE_REF="${ACR_NAME}.azurecr.io/${IMAGE_REPO}:${IMAGE_TAG}"
          echo "IMAGE_REF=${IMAGE_REF}" >> "$GITHUB_OUTPUT"
          az acr build -r "${ACR_NAME}" -t "${IMAGE_REPO}:${IMAGE_TAG}" .

      - name: Update Container App
        id: update
        run: |
          set -euo pipefail
          REV="r$(date +%H%M%S)"
          az containerapp update \
            -n "${APP_NAME}" \
            -g "${RESOURCE_GROUP}" \
            --image "${{ steps.build.outputs.IMAGE_REF }}" \
            --revision-suffix "${REV}"
          LATEST_REV="$(az containerapp show -n "${APP_NAME}" -g "${RESOURCE_GROUP}" --query "properties.latestRevisionName" -o tsv)"
          echo "LATEST_REV=${LATEST_REV}" >> "$GITHUB_OUTPUT"

      - name: Wait For Healthy Revision
        run: |
          set -euo pipefail
          for i in $(seq 1 30); do
            STATE="$(az containerapp revision show -n "${APP_NAME}" -g "${RESOURCE_GROUP}" --revision "${{ steps.update.outputs.LATEST_REV }}" --query "properties.healthState" -o tsv)"
            if [ "$STATE" = "Healthy" ]; then
              echo "Revision is healthy."
              exit 0
            fi
            echo "Current health state: ${STATE:-unknown} (attempt $i/30)"
            sleep 10
          done
          echo "New revision did not become healthy in time."
          exit 1

      - name: Show Endpoint
        run: |
          set -euo pipefail
          FQDN="$(az containerapp show -n "${APP_NAME}" -g "${RESOURCE_GROUP}" --query "properties.configuration.ingress.fqdn" -o tsv)"
          echo "Endpoint: https://${FQDN}/"
